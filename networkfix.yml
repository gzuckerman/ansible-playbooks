---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# NetworkFix
# https://cloud.redhat.com/insights/remediations/005d86f5-3b1b-41e8-abbe-2688cd84b240
# Generated by Red Hat Insights on Mon, 16 Nov 2020 12:42:50 GMT
# Created by gregory.zuckerman

- name: run insights to obtain latest diagnosis info
  hosts: "127.0.0.1"
  become: True
  tasks:
    - name: obtain diagnosis info
      command: 'insights-client --diagnosis 005d86f5-3b1b-41e8-abbe-2688cd84b240'
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# Network performance degradation when networking parameters are not properly tuned
# Identifier: (advisor:setup_netdev_packetdrop_params|NETDEV_PACKET_DROPS_OBSERVED,fix)
# Version: a9efd26a0de67acf697c81b4930b1f3c2c7b86a8
- name: Update kernel parameters netdev max backlog and budget
  hosts: "127.0.0.1"
  become: true
  vars:
    pydata: "{{ insights_report.details['setup_netdev_packetdrop_params|NETDEV_PACKET_DROPS_OBSERVED'] }}"

  tasks:
    - when:
        - pydata is defined
        - pydata.set_up_ring is defined
      block:
        - when: (ansible_distribution_major_version == '7') or (ansible_distribution_major_version == '8')
          block:
            - name: Create basic network script, if it doesn't exist already
              copy:
                content: |
                  DEVICE={{ item.iface }}
                  ONBOOT=yes
                  BOOTPROTO=none
                  NM_CONTROLLED=no
                dest: "/etc/sysconfig/network-scripts/ifcfg-{{ item.iface }}"
                mode: 0755
                force: no
                owner: root
                group: root
              with_items: "{{ pydata.set_up_ring }}"

            - name: Adding ETHTOOL_OPTS to set interface RX ring values to maximums
              lineinfile:
                path: /etc/sysconfig/network-scripts/ifcfg-{{ item.iface }}
                state: present
                line: ETHTOOL_OPTS="-G {{ item.iface }} rx {{ item.max_rx }}"
              with_items: "{{ pydata.set_up_ring }}"

            - name: Restart network service to apply the changes
              service:
                name: network
                state: restarted
                enabled: yes
              ignore_errors: true

            - name: Create the dispatcher script for NetworkManager
              file:
                path: /etc/NetworkManager/dispatcher.d/30-ethtool-rxmax-conf
                state: touch
                mode: u+rwx,g-rx,o-rx

            - name: Set interface RX ring values to maximums
              lineinfile:
                path: /etc/NetworkManager/dispatcher.d/30-ethtool-rxmax-conf
                line: ethtool -G {{ item.iface }} rx {{ item.max_rx }}
                create: yes
                mode: 0755
                owner: root
                group: root
              with_items: "{{ pydata.set_up_ring }}"

            - name: Restart NetworkManager service to apply the changes
              service:
                name: NetworkManager
                state: restarted
              ignore_errors: true
        - when: (ansible_distribution_major_version == '6')
          block:
            - name: Create basic network script, if it doesn't exist already
              copy:
                content: |
                  DEVICE={{ item.iface }}
                  ONBOOT=yes
                  BOOTPROTO=none
                  NM_CONTROLLED=no
                dest: "/etc/sysconfig/network-scripts/ifcfg-{{ item.iface }}"
                mode: 0755
                force: no
                owner: root
                group: root
              with_items: "{{ pydata.set_up_ring }}"

            - name: Adding ETHTOOL_OPTS to set interface RX ring values to maximums
              lineinfile:
                path: /etc/sysconfig/network-scripts/ifcfg-{{ item.iface }}
                state: present
                line: ETHTOOL_OPTS="-G {{ item.iface }} rx {{ item.max_rx }}"
              with_items: "{{ pydata.set_up_ring }}"

            - name: Restart network service to apply the changes
              service:
                name: network
                state: restarted
                enabled: yes
              ignore_errors: true

    - when:
        - pydata is defined
        - pydata.set_sysctl is defined
      block:
        - when: pydata.set_sysctl['net.core.netdev_max_backlog'] is defined
          name: Set sysctl net.core.netdev_max_backlog to 10000
          sysctl:
            name: net.core.netdev_max_backlog
            value: 10000
            sysctl_set: yes

        - when: pydata.set_sysctl['net.core.netdev_budget'] is defined
          name: Set sysctl net.core.netdev_budget to 600
          sysctl:
            name: net.core.netdev_budget
            value: 600
            sysctl_set: yes


- name: run insights
  hosts: "127.0.0.1"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false