---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Insights
# https://cloud.redhat.com/insights/remediations/6592fb70-51be-4639-a146-4de37f0f380c
# Generated by Red Hat Insights on Mon, 16 Nov 2020 12:36:59 GMT
# Created by gregory.zuckerman

- name: run insights to obtain latest diagnosis info
  hosts: "127.0.0.1"
  become: True
  tasks:
    - name: obtain diagnosis info
      command: 'insights-client --diagnosis 6592fb70-51be-4639-a146-4de37f0f380c'
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# The system hangs and the grub menu never gets loaded when rebooting due to a known bug in the shim package
# Identifier: (advisor:system_hang_due_to_shim_pkg|GRUB_BOOT_ERROR_DUE_TO_SHIM,fix)
# Version: f6d5a06650854320c3916e17d94acf83392aa55f
- name: Update shim package
  hosts: "127.0.0.1"
  become: true
  vars:
    pydata: "{{ insights_report.details['system_hang_due_to_shim_pkg|GRUB_BOOT_ERROR_DUE_TO_SHIM']| default('') }}"

  tasks:
    - name: Update {{ pydata.pkg_name }} package
      yum:
        name: "{{ pydata.pkg_name }}"
        state: latest
      when: pydata.pkg_name is defined


- name: run insights
  hosts: "127.0.0.1"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
